name: SmartTrader Production Workflow
on:
  push:
    tags:
    - production_*
jobs:
    build_test_and_publish:
        name: Build and Test
        runs-on: ubuntu-latest
        steps:
        # checkout the repository content to github runner
        - name: Checkout
          uses: actions/checkout@v4
        # setup nodejs environment
        - name: Setup Node.js environment
          uses: ./.github/actions/setup_node
        # cache the dependencies to speed up the build and then install dependencies
        - name: Cache dependencies
          uses: ./.github/actions/npm_install_from_cache
        # build the react app
        - name: Build
          run: npm run build
        # run tests
        - name: Publish to Cloudflare Staging
          uses: ./.github/actions/publish_to_cloudflare_production

    send_slack_notification:
        name: Send Slack notification
        runs-on: Runner_16cores_Deriv-app
        environment: Production
        if: always()
        needs: [build_test_and_publish]
        steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Conclusion
          uses: technote-space/workflow-conclusion-action@v3
        - name: Send Slack Notification
          uses: "./.github/actions/send_slack_notifications"
          with:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
            status: ${{ env.WORKFLOW_CONCLUSION }}
            release_type: Production 
            version: $GITHUB_REF_NAME
